{% extends 'membersBase.html' %}

{% block content %}


<!-- accounts page start -->
<section class="accounts-section" id="accountsSection">


    <!-- my account start -->
    <article class="myAccounts memberPortal-accounts" id="myAccountArticle">
        <div class="my-member-tittle profile-tittle">
            <p class="p-title" >My Shares :</p>
        </div>
        <div class="my-accounts">

            <!-- general summary stats start -->
            <div class="summary">
                <p>Monthly Share Contribution</p>
                <div class="summary_values">
                    <div class="valuedata">
                        <p> {{ share_amount }} KES</p>
                    </div>
                    <figure id="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%;">
                        <img id="profile-image" src="../../static/images/pics/deposit-ico.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                    </figure>
                </div>
            </div>

            <div class="summary">
                <p>Total Shares Contributed</p>
                <div class="summary_values">
                    <div class="valuedata">
                        <p>{{ shares_balance }} KES</p>
                    </div>
                    <figure id="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%;">
                        <img id="profile-image" src="../../static/images/pics/deposit-ico.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                    </figure>
                </div> 
            </div>

            <div class="summary">
                <p>Contributed Cycles</p>
                <div class="summary_values">
                    <div class="valuedata">
                        <p> {{ share_contributions_count }} months</p>
                    </div>
                    <figure id="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%;">
                        <img id="profile-image" src="../../static/images/pics/credit.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                    </figure>
                </div> 
            </div>
        </div>  

        <!-- loan summary stats start -->
        <div class="my-member-tittle profile-tittle">
            <p id="showMyLoans" class="p-title" >My Loans <i class="fa fa-chevron-right" aria-hidden="true"></i></p>
        </div>

        <div class="dropdown-select-toggle" id="dropdown-select-toggle" style="display: none;">
            <a href="#" class="toggle-advance">View Outstanding Advance Loan </a> <br>
            <div class="my-accountl-adv grid-display" style="display: none;">
                <div class="summary">
                    <p>Advance Loan Principal</p>
                    <div class="summary_values">
                        <div class="valuedata">
                            <p>{{ salary_advance_loan }}</p>
                        </div>
                        <figure class="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%; margin-left:1vw;">
                            <img class="profile-image" src="../../static/images/pics/deposit-ico.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                        </figure> 
                    </div>
                </div>
                
                <div class="summary">
                    <p>Advance Loan Interest</p>
                    <div class="summary_values">
                        <div class="valuedata">
                            <p>{{ salary_advance_loan_interest }}</p>
                        </div>
                        <figure class="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%; margin-left:1vw;">
                            <img class="profile-image" src="../../static/images/pics/withdraw-icon.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                        </figure> 
                    </div>
                </div>
                
                <div class="summary">
                    <p>Advance Loan Repayable</p>
                    <div class="summary_values">
                        <div class="valuedata">
                            <p>{{ advance_loan_repayable }}</p>
                        </div>
                        <figure class="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%; margin-left:1vw;">
                            <img class="profile-image" src="../../static/images/pics/withdraw-icon.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                        </figure> 
                    </div>
                </div>
            </div>

            <a href="#" class="toggle-welfare">View Outstanding Welfare Loan </a> <br>
            <div class="my-accountl-wel grid-display" style="display: none;">
                <div class="summary">
                    <p>Welfare Loan Principal</p>
                    <div class="summary_values">
                        <div class="valuedata">
                            <p>{{ normal_loan }}</p>
                        </div>
                        <figure id="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%;margin-left:1vw;">
                            <img id="profile-image" src="../../static/images/pics/deposit-ico.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                        </figure> 
                    </div>
                </div>
                <div class="summary">
                    <p>Welfare Loan Interest</p>
                    <div class="summary_values">
                        <div class="valuedata">
                            <p>{{ normal_loan_interest }}</p>
                        </div>
                        <figure id="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%;margin-left:1vw;">
                            <img id="profile-image" src="../../static/images/pics/withdraw-icon.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                        </figure> 
                    </div>
                </div>
                
                <div class="summary">
                    <p> Welfare Loan Repayable</p>
                    <div class="summary_values">
                        <div class="valuedata">
                            <p> {{  normal_loan_repayable }} </p>
                        </div>
                        <figure id="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%;margin-left:1vw;">
                            <img id="profile-image" src="../../static/images/pics/withdraw-icon.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                        </figure> 
                    </div>
                </div>
            </div>

            <a href="#" class="toggle-loan-summary">View Outstanding Loan Summary </a>
            <div class="my-accountl-sumy grid-display" style="display: none;">
                <div class="summary">
                    <p>Outstanding Loan Principal</p> 
                    <div class="summary_values">
                        <div class="valuedata">
                            <p>{{ outstanding_loan_principal }}</p>
                        </div>
                        <figure class="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%; margin-left:1vw;">
                            <img class="profile-image" src="../../static/images/pics/deposit-ico.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                        </figure> 
                    </div>
                </div>
                
                <div class="summary">
                    <p>Outstanding Loan Interest</p>
                    <div class="summary_values">
                        <div class="valuedata">
                            <p>{{ outstanding_loan_interest }}</p>
                        </div>
                        <figure class="profile-container" style="width: 40px; height: 40px; overflow: hidden; border-radius: 50%; margin-left:1vw;">
                            <img class="profile-image" src="../../static/images/pics/credit.svg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                        </figure> 
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- recent activities start -->
        <div class="my-member-tittle profile-tittle">
            <p>My Recent Activities :</p>                 
        </div>

        <table class="tbl" style="padding: 4vw;">
            <thead>
                <tr>
                    <th>Transaction Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                {% if transactions %}
                    {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.posting_date }}</td>
                            <td>{{ transaction.description }}</td>
                            <td>
                                {% if transaction.credit %}
                                    {{ transaction.credit }}
                                {% elif transaction.debit %}
                                    -{{ transaction.debit }}
                                {% else %}
                                    0.00
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="3">You don't have any recent activity at the moment.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>     
    </article>
    <!-- my account end -->

    <!-- funds transfer start -->
    <article class="shareTransfer memberPortal-accounts" id="fundsTransferArticle">
        <div class="centered">
            <div class="my-member-tittle profile-tittle">
                <p class="p-title"  >Shares Transfer Form :</p>
            </div>
    
            <!-- form start -->
            <form action="#" method="POST" class="blockAccountForm">
                {% csrf_token %}
            
                <div class="blockAccountFormGroups">
                    <div class="form-group">
                        <input type="text" name="membernumberst" id="membernumberst" class="membernumberba" placeholder="Enter receiver's member number" required>
                    </div>
                    <div class="form-group">
                        <input type="number" name="shareAmountToTransfer" id="shareAmountToTransfer" class="shareAmountToTransfer" placeholder="Enter shares to transfer" required>
                    </div>
                    <div class="form-group blockReasonGroup">
                        <textarea name="transferReason" class="blockReason" id="transferReason" cols="40" rows="5" placeholder="Reason for share transfer" required></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <input type="submit" value="Submit Request" id="submitShareTransfer" class="submitBlockAccount">
                </div>

            </form>

        </div>
    </article>
    <!-- funds transfer end -->


    <!-- adjusted contribution start -->
    <article class="adjustContributions memberPortal-accounts" id="adjustedContributionArticle">     
        <div class="centered">
            <div class="my-member-tittle profile-tittle">
                <p class="p-title"  >Adjust Share Contrubtions Form :</p>
            </div>

            <!-- form start -->
            <form id="shareAdjustmentForm" class="blockAccountForm">
                <div class="blockAccountFormGroups">
                    <div class="form-group">
                        <label for="memberNumbersa">Member Number:</label>
                        <input type="text" name="memberNumbersa" id="memberNumbersa" class="membernumberfa" value="{{ user.member_number }}" readonly required>
                    </div>
                    <div class="form-group">
                        <label for="adjustContributions_amount">Adjust Contributions:</label>
                        <input type="number" name="adjustContributions_amount" id="adjustContributions_amount" class="adjustContributions_amountfa" placeholder="Share amount to contribute" required>
                    </div>
                </div>
            
                <div class="btn-group">
                    <input type="submit" value="Submit Request" id="submitShareAdjustment" class="submitShareAdjustment submitBlockAccount">
                </div>
            </form>            

        </div>
    </article>
    <!-- adjusted contribution end -->  


    <!-- Benevolent Claim Application Start -->  
    <article class="benevolent memberPortal-accounts" id="benovelentClaimArticle">
        
        <!-- claim wrapper -->
        <div class="centered">
            <div class="my-member-tittle profile-tittle">
                <p class="p-title"  >Benevolent Claim Application Form :</p>
            </div>

            <!-- form start -->
            <form action="#" method="post" class="benovelentClaimFormData" id="benovelentClaimFormData">

                <!-- Member Details -->
                <div class="memberDetails">
                    <p class="htb">Member Details:</p>
                    <div class="memberDetailsContents">
                        <div class="form-group">
                            <label for="full_name">Full Name:</label>
                            <input type="text" name="full_name" id="full_name" class="full_name" value="{{ full_name }}" readonly required>
                        </div>
                        <div class="form-group">
                            <label for="id_number">ID Number:</label>
                            <input type="text" name="id_number" id="id_number" class="id_number" value="{{ member_idno }}" readonly required>
                        </div>
                        <div class="form-group">
                            <label for="phone_number">Phone Number:</label>
                            <input type="tel" name="phone_number" id="phone_number" class="phone_number" value="{{ phone_number }}" readonly required>
                        </div>
                        <div class="form-group">
                            <label for="position">Position:</label>
                            <input type="text" name="position" id="position" class="position" value="{{ member_position }}" readonly required>
                        </div>
                        <div class="form-group">
                            <label for="residence">Residence:</label>
                            <input type="text" name="residence" id="residence" class="residence" value="{{ residence }}" readonly required>
                        </div>
                    </div>
                </div>
 
                <!-- Deceased Information -->
                <div class="deceasedInformation">
                    <p class="htb">Deceased Information:</p>
                    <div class="deceasedInformationContents">
                        <table id="deceasedInformationTable" class="tbl">
                            <thead>
                                <tr>
                                    <th>Deceased Name</th>
                                    <th>Relationship</th>
                                    <th>ID Number</th>
                                    <th>Date of Birth</th>
                                    <th>Date of Death</th>
                                </tr>
                            </thead>
                            <tbody id="deceasedInformationList">
                                <!-- Display the picked deceased information here -->
                            </tbody>
                        </table>
                       
                    </div>    

                    <!-- Deceased Information Popup -->
                    <div class="overlaydi overlay" id="overlaydi">
                        <div class="popupdi popup">
                            <div class="closebtn">
                                <a href="#" id="popupCloseButtondi"><i class="fa fa-times" aria-hidden="true"></i></a>
                                <a href='#' id="processTitleLink" class="processTitleLink">Add Deceased Information</a>
                            </div>
                            <div id="deceasedInformationPopupContent">
                                <!-- Deceased Information details will be shown here -->
                            </div> 
                            <button id="popupCloseButtondi2" class="popupCloseButtondi2">
                                <a href='#' id="closeLink" class="closeLink">Close</a>
                            </button>
                            <button type="button" id="nextLink" class="nextLink">Save and Continue</button> 
                        </div>                         
                    </div>
                    <div id="deceasedInformationBtn" class="deceasedInformationBtn" style="width: fit-content;">Add Deceased Information</div>            
                </div>

                <!-- Bank Details  -->
                <div class="bankDetails">
                    <p class="htb">Bank Details:</p>
                    <div class="bankDetailsContents">
                        <div class="form-group">
                            <label for="account_name">Account Name:</label>
                            <input type="text" name="account_name" id="account_name" class="account_name" required>
                        </div>
                        <div class="form-group">
                            <label for="account_number">Account Number:</label>
                            <input type="text" name="account_number" id="account_number" class="account_number" required>
                        </div>
                        <div class="form-group">
                            <label for="bank">Bank:</label>
                            <input type="text" name="bank" id="bank" class="bank" required>
                        </div>
                        <div class="form-group">
                            <label for="branch">Branch:</label>
                            <input type="text" name="branch" id="branch" class="branch" required>
                        </div>
                    </div>                
                </div>  

                <!-- Member Declaration -->
                <div class="memberDeclaration">
                    <p class="htb">Member Declaration:</p>
                    <div class="declarationDeclarationContents">
                        <p>I hereby declare that the foregoing particulars are true to the best of my knowledge and belief and agree to
                            abide by the bylaws of the Welfare, Credit policy and any variations by the Benevolent Committee in respect to
                            aforementioned details</p>
                        <p>
                            <label>
                                <input type="checkbox" name="agreement" value="accepted" required>
                                By checking this box, I hereby commit to service the Benevolent according to the terms.
                            </label>
                        </p>
                    </div>
                </div>

                
                <div class="benevolentButton">
                    <input type="submit" name="benevolentButton" id="benevolentClaimSubmitButton" class="benevolentButtonInput" value="Submit Application">
                </div>
                
            </form>  
        </div>

    </article>
    <!-- Benevolent Claim Application End --> 


    <!-- account statement start -->
    <article class="accountStatement memberPortal-accounts" id="accountStatementArticle">
        <div class="centered">
            <div class="user-account-statement">
                <article class="tbl_container">
                    <label for="filterSelect"><i class='bx bx-filter'></i>Filter by:</label>
                    <select id="filterSelect">
                        <option value="all">All</option>
                        <option value="shares">Shares</option>
                        <option value="loan disbursed">Loan Disbursed</option>
                        <option value="advance loan">Advance Loan</option>
                        <option value="normal loan">Normal Loan</option>
                    </select>
                    <!-- Add date range inputs -->
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate">
                    
                    <table class="tbl">
                        <thead>
                            <tr>
                                <th>Posting Date</th>
                                <th>Activity</th>
                                <th>Description</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if transactions %}
                                {% for transaction in transactions %}
                                    <tr data-status="{{ transaction.activity_type }}" data-is-approved="{% if activity_type.posting_date %}true{% else %}false{% endif %}">
                                        <td>{{ transaction.posting_date }}</td>
                                        <td>{{ transaction.activity_type }}</td>
                                        <td>{{ transaction.description }}</td>
                                        <td>{{ transaction.debit }}</td>
                                        <td>{{ transaction.credit }}</td>
                                        <td>{{ transaction.balanceU }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6">You don't have any recent activity at the moment.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>              
                </article>
            </div>
        </div>
    </article>
    <!-- account statement end -->


    <!-- block account start -->
    <article class="blockAccount memberPortal-accounts" id="blockAccountArticle">
        <div class="centered">
            <div class="my-member-tittle profile-tittle">
                <p>Block Account Form :</p>
            </div>
            <form action="{% url 'block_account_request' %}" method="POST" id="blockAccountForm" class="blockAccountForm">
                {% csrf_token %}
            
                <div class="blockAccountFormGroups">
                    <div class="form-group">
                        <input type="text" name="membernumberba" id="memberNumberba" class="membernumberba" value="{{ user.member_number }}" readonly required>
                    </div>
                    <div class="form-group blockReasonGroup">
                        <textarea name="blockReason" id="blockReason" class="blockReason" cols="40" rows="5" placeholder="Reason for blocking account" required></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <input type="submit" value="Submit Request" id="submitBlockAccount" class="submitBlockAccount">
                </div>
            </form>
        </div>
    </article>
    <!-- block account end -->


</section>


 <!-- ... (previous HTML code) ... -->
 <script>
    $(document).ready(function () {
        // Retrieve the filter value and date range from localStorage
        const storedFilter = localStorage.getItem('selectedFilter');
        const storedStartDate = localStorage.getItem('startDate');
        const storedEndDate = localStorage.getItem('endDate');

        // Set the initial values based on stored values or default to 'all'
        $('#filterSelect').val(storedFilter || 'all');
        $('#startDate').val(storedStartDate || '');
        $('#endDate').val(storedEndDate || '');

        // Function to handle filter change
        $('#filterSelect, #startDate, #endDate').change(function () {
            const selectedFilter = $('#filterSelect').val();
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();

            // Store the selected filter and date range in localStorage
            localStorage.setItem('selectedFilter', selectedFilter);
            localStorage.setItem('startDate', startDate);
            localStorage.setItem('endDate', endDate);

            // Show/hide rows based on filter and date range
            $('tbody tr').each(function () {
                const activityType = $(this).data('status');
                const postingDate = $(this).find('td:first').text();

                // Parse the postingDate to a Date object
                const transactionDate = new Date(postingDate);

                // Check if the transactionDate is within the selected date range
                const isDateInRange = (!startDate || transactionDate >= new Date(startDate)) && (!endDate || transactionDate <= new Date(endDate));

                if (
                    (selectedFilter === 'normal loan' && (activityType === 'normal loan repayment' || activityType === 'normal loan interest')) ||
                    (selectedFilter === 'advance loan' && (activityType === 'advance loan repayment' || activityType === 'advance loan interest')) ||
                    (selectedFilter === 'shares' && activityType === 'shares') ||
                    (selectedFilter === 'loan disbursed' && activityType === 'loan disbursed') ||
                    selectedFilter === 'all'
                ) {
                    $(this).toggle(isDateInRange);  // Show/hide based on both filter and date range
                } else {
                    $(this).hide();
                }
            });
        });

        // Trigger the change event on page load to apply the initial filter and date range
        $('#filterSelect, #startDate, #endDate').trigger('change');
    });
</script>
<!-- ... (remaining HTML code) ... -->
{% endblock %}
